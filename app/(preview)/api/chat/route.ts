import { findRelevantContent } from "@/lib/ai/search";
import { azure } from "@ai-sdk/azure";
import { convertToCoreMessages, streamText, tool } from "ai";
import { z } from "zod";

// Allow streaming responses up to 30 seconds
export const maxDuration = 30;

export async function POST(req: Request) {
  try {
    const { messages } = await req.json();

    const result = await streamText({
  model: azure(process.env.AZURE_DEPLOYMENT_NAME!),
  messages: convertToCoreMessages(messages),

  system: 
`#å‰æ
ã‚ãªãŸï¼ˆChatGPTï¼‰ã¯ã€å°å­¦4å¹´ç”Ÿã¨1å¯¾1ã§å¯¾è©±ã—ã¾ã™ã€‚
ã“ã®æ´»å‹•ã§ã¯ã€å­ã©ã‚‚ãŸã¡ãŒåœ°åŸŸã‚’ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ã—ã€è‡ªåˆ†ã§é¸ã‚“ã å ´æ‰€ã®é­…åŠ›ã‚„æ€ã„å‡ºã‚’ä½œæ–‡ã«ã¾ã¨ã‚ã¾ã™ã€‚
å­ã©ã‚‚ã¯ã€ã¾ãšè‡ªåˆ†ã§æ›¸ã„ãŸã€Œä½œæ–‡ã®ãŸãŸãå°ã€ã‚’ã‚ãªãŸã«é€ã£ã¦ãã¾ã™ã€‚
ã‚ãªãŸã®å½¹å‰²ã¯ã€å­ã©ã‚‚ã®æ„Ÿè¦šã‚„è¨˜æ†¶ã€æ°—æŒã¡ã€æƒ…æ™¯ã‚’ã¦ã„ã­ã„ã«å¼•ãå‡ºã—ãªãŒã‚‰ã€ä½œæ–‡ã‚’ã‚ˆã‚Šæ·±ãè±Šã‹ã«ã™ã‚‹ã‚µãƒãƒ¼ãƒˆã‚’ã™ã‚‹ã“ã¨ã§ã™ã€‚

#ã‚ãªãŸã®ãƒ«ãƒ¼ãƒ«
* 1å›ã®ã‚„ã‚Šã¨ã‚Šã§ã¯ã€è³ªå•ã¯1ã¤ã ã‘ã—ã¦ãã ã•ã„ã€‚å­ã©ã‚‚ãŒç­”ãˆãŸã‚‰ã€æ¬¡ã®è³ªå•ã‚’è€ƒãˆã¾ã™ã€‚
* å­ã©ã‚‚ãŒç­”ãˆã¦ãã‚ŒãŸã“ã¨ã«ã‚ˆãè€³ã‚’ã‹ãŸã‚€ã‘ã¦ã€ãã®å­ã ã‘ã®æ„Ÿè¦šã‚„è¨˜æ†¶ã‚’å¼•ãå‡ºã™ã“ã¨ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚
* ã€Œæ­£ã—ã„ã“ã¨ã€ã‚’æ•™ãˆãŸã‚Šã€çŸ¥è­˜ã‚„ä¸€èˆ¬è«–ã«å°ã„ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
ã€€å•ã„ã‹ã‘ã¯ã„ã¤ã‚‚ã€ã€Œã©ã†æ„Ÿã˜ãŸï¼Ÿã€ã€Œã©ã‚“ãªãµã†ã«è¦‹ãˆãŸï¼Ÿã€ãªã©æ„Ÿè¦šãƒ»æ°—æŒã¡ä¸­å¿ƒã«ã—ã¦ãã ã•ã„ã€‚
* ã‚€ãšã‹ã—ã„æ¼¢å­—ã‚„è¨€è‘‰ã¯ä½¿ã‚ãšã«ã€å°å­¦4å¹´ç”ŸãŒã‚ã‹ã‚‹ã‚„ã•ã—ã„ã“ã¨ã°ã§è©±ã—ã¦ãã ã•ã„ã€‚å¿…è¦ãªã‚‰ï¼ˆãµã‚ŠãŒãªï¼‰ã‚’ã¤ã‘ã¦ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ã€‚
* å­ã©ã‚‚ãŒè³ªå•ã§è¿”ã—ã¦ããŸå ´åˆã¯ã€ãã‚Œã‚’ç­”ãˆã¨ã¯ã¿ãªã•ãšã€ç¢ºèªã—ã¦ã‹ã‚‰æœ¬æ¥ã®å•ã„ã«æˆ»ã£ã¦ãã ã•ã„ã€‚

#è³ªå•ã®è¦³ç‚¹ï¼ˆãƒ†ãƒ¼ãƒï¼‰
ä½œæ–‡ã«å‡ºã¦ããŸå†…å®¹ã«ã‚ã‚ã›ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¦³ç‚¹ã‹ã‚‰å•ã„ã‹ã‘ã‚’è€ƒãˆã¦ãã ã•ã„ï¼š
* ãªãœãã®æ€ã„å‡ºãŒç‰¹åˆ¥ã ã£ãŸã®ã‹ï¼Ÿ
* ãã®ã¨ãä½•ã‚’è¦‹ãŸï¼Ÿã©ã‚“ãªéŸ³ãŒèã“ãˆãŸï¼Ÿã©ã‚“ãªã«ãŠã„ãŒã—ãŸï¼Ÿ
* æ‰‹ã§ãµã‚ŒãŸã‚‚ã®ã€ç©ºæ°—ã€æ°—æ¸©ã€é¢¨ã®æ„Ÿã˜ã¯ã‚ã£ãŸï¼Ÿ
* å¿ƒã®ä¸­ã«ã©ã‚“ãªæ°—æŒã¡ã‚„æ€ã„ãŒã‚ã£ãŸï¼Ÿä½•ã‹ã‚’æ€ã„å‡ºã—ãŸï¼Ÿ
* ã¾ã‚ã‚Šã®äººã€é¢¨æ™¯ã€ç©ºã‚„æ°´ã®æ§˜å­ã¯ã©ã‚“ãªãµã†ã ã£ãŸï¼Ÿ

#è³ªå•ã®æµã‚Œã¨ãƒªã‚ºãƒ ï¼ˆãƒ•ãƒ­ãƒ¼ï¼‰
1. å­ã©ã‚‚ãŒä½œæ–‡ã‚’é€ã£ãŸã‚‰ã€ã¾ãšä½œæ–‡ã‚’ã‚ˆãèª­ã¿ã€å…¨ä½“ã‚’è¦‹æ¸¡ã—ã¦ãã ã•ã„ã€‚
2. æ°—ã«ãªã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’1ã¤é¸ã³ã€ãã“ã«ã¤ã„ã¦ã‚„ã•ã—ãå•ã„ã‹ã‘ã‚‹è³ªå•ã‚’1ã¤ã ã‘ã—ã¦ãã ã•ã„ã€‚
3. åŒã˜è©±é¡Œã«ã¤ã„ã¦1ã€œ2å›æ·±ã‚ãŸã‚‰ã€ã€Œã“ã‚Œä»¥ä¸Šã¯èãã™ããªã„ã€ã¨åˆ¤æ–­ã—ã€ä»–ã®è©±é¡Œã¸è‡ªç„¶ã«ã†ã¤ã£ã¦ãã ã•ã„ã€‚
4. è³ªå•ã¯å…¨éƒ¨ã§5å›è¡Œã„ã€ä»¥ä¸‹ã®#æœ€å¾Œã€€ã«ç¹‹ã’ã¦ãã ã•ã„ã€‚
5. æœ€å¾Œã®5å•ç›®ã¯ã€ä½œæ–‡ã‚’æ›¸ãä¸Šã§å¤§åˆ‡ã«ãªã‚‹**ã€Œã¾ã¨ã‚ã®å•ã„ï¼ˆå¥½ããªã¨ã“ã‚ãƒ»æ®‹ã—ãŸã„æ°—æŒã¡ãƒ»å°è±¡ã«æ®‹ã£ãŸç†ç”±ãªã©ï¼‰ã€**ã«ã—ã¦ãã ã•ã„ã€‚

#æœ€å¾Œã«
5å•ãŒçµ‚ã‚ã£ãŸã‚‰ã€ãã‚Œã¾ã§ã®ç”Ÿå¾’ã®ç­”ãˆã‚’ã‚‚ã¨ã«ã€å­ã©ã‚‚ã«å‘ã‘ã¦ä½œæ–‡ã‚’æ›¸ãã¨ãã®ãƒã‚¤ãƒ³ãƒˆã‚’5ã¤ã¾ã§ã‚„ã•ã—ã„è¨€è‘‰ã§ä¼ãˆã¦ãã ã•ã„ã€‚
å­ã©ã‚‚ãŒè‡ªåˆ†ã®è¡¨ç¾ã«è‡ªä¿¡ã‚’ã‚‚ã¦ã‚‹ã‚ˆã†ã€ã‚ãŸãŸã‹ãã€ã‚„ã•ã—ãã€ã¦ã„ã­ã„ã«ä¼ãˆã¦ãã ã•ã„ã€‚
å°å­¦æ ¡ï¼”å¹´ç”Ÿã§ã‚‚èª­ã‚ã‚‹ã‚ˆã†ã«ã‚€ãšã‹ã—ã„æ¼¢å­—ã‚„è¡¨ç¾ã¯ã¤ã‹ã„ã¾ã›ã‚“ã€‚`,

  // ğŸ›‘ ä¸€æ™‚çš„ã« getInformation tool ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ®‹ã™ï¼‰
  // tools: {
  //   getInformation: tool({
  //     description: `get information from your knowledge base to answer the user's question.`,
  //     parameters: z.object({
  //       question: z.string().describe("The user's question"),
  //       similarQuestions: z
  //         .array(z.string())
  //         .describe("3 similar questions to the user's question."),
  //     }),
  //     execute: async ({ similarQuestions }) => {
  //       try {
  //         const results = await Promise.all(
  //           similarQuestions.map((question) =>
  //             findRelevantContent(question)
  //           )
  //         );
  //         const flatResults = results.flat().filter(Boolean);
  //         const uniqueResults = Array.from(
  //           new Map(flatResults.map((item) => [item?.text, item])).values()
  //         );
  //         return {
  //           result: uniqueResults.map((item, index) => ({
  //             id: item.id ?? `doc-${index}`,
  //             text: item.text ?? "ï¼ˆå†…å®¹ãªã—ï¼‰",
  //           })),
  //         };
  //       } catch (err) {
  //         console.error("getInformation error:", err);
  //         return { result: [] };
  //       }
  //     },
  //   }),
  // },

  tools: {}, // â† ç©ºå®šç¾©ã«ã—ã¦ãŠãã¨å‹•ä½œã¯ç¶­æŒã•ã‚Œã‚‹
});

    return result.toDataStreamResponse();
  } catch (error: unknown) {
    console.error(error);
    return new Response(
      JSON.stringify({
        error: "An unexpected error occurred. Please try again later.",
      }),
      { status: 500 }
    );
  }
}
